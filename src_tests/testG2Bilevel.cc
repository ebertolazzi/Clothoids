//#define _USE_MATH_DEFINES
#include "Clothoids.hh"
#include "Clothoids_fmt.hh"
#include "Utils_eigen.hh"

using G2lib::real_type;
using G2lib::integer;
using namespace std;

struct curveLocProp{
  G2lib::integer id = -1;
  G2lib::real_type s_begin = 0.0;
  G2lib::real_type s_end = 0.0;
  std::vector<G2lib::real_type> s_peaks;
};

struct wayLine{
  G2lib::real_type s = 0.0;
  G2lib::real_type n_min = 0.0;
  G2lib::real_type n_max = 0.0;
};


void
create_waylines(
  const std::vector<curveLocProp>& Curves,
  std::vector<wayLine>& Waylines,
  const G2lib::real_type curve_separation_tol = 100.0
)
{
  Waylines.emplace_back( wayLine{ 0.0, -4.0,4.0 } );
  for ( size_t i = 0; i < Curves.size() - 1; ++i ) {
    const real_type prev_loc = Waylines.back().s;
    const real_type next_loc = Curves[i+1].s_begin;
    const real_type dist = next_loc - prev_loc;
    if ( dist > curve_separation_tol ) {
      const size_t n_waylines = static_cast<size_t>( std::floor( dist / curve_separation_tol ) );
      const real_type wayline_spacing = dist / static_cast<real_type>( n_waylines + 1 );
      for ( size_t j = 1; j <= n_waylines; ++j ) {
        const real_type wayline_loc = prev_loc + j * wayline_spacing;
        Waylines.emplace_back( wayLine{ wayline_loc, -4.0,4.0 } );
      }
    }
    // add the curve peak as wayline
    for ( const auto& peak_loc : Curves[i+1].s_peaks ) {
      Waylines.emplace_back( wayLine{ peak_loc, -4.0,4.0 } );
    }
    // add the end of the curve as wayline
    Waylines.emplace_back( wayLine{ Curves[i+1].s_end, -4.0,4.0 } );
  }
}

//

G2lib::real_type
compute_curvature_cost(
  G2lib::ClothoidList& S_base,
  std::vector<wayLine>& Waylines,
  std::vector<G2lib::real_type>& offsets
)
{
  fmt::print( "\nCompute curvature cost...\n" );
  G2lib::integer n_waylines = Waylines.size();
  // create vectors of x anf y coordinates to rebuild a new G2 object after optimization
  std::vector<real_type> X_new( n_waylines, 0.0 );
  std::vector<real_type> Y_new( n_waylines, 0.0 );
  fmt::print( "Evaluate new wayline points...\n" );
  for ( G2lib::integer i = 0; i < n_waylines; ++i ) {
    auto s_loc = Waylines[i].s;
    auto offs = offsets[i];
    S_base.eval_ISO(s_loc, offs, X_new[i], Y_new[i]);
  }
  fmt::print( "Rebuild new G2 object...\n" );
  // build new G2 object
  G2lib::ClothoidList S_new("BILEVEL_NEW");
  S_new.build_G2_cyclic( n_waylines, X_new.data(), Y_new.data() );
  //
  std::vector<real_type> SS_new( n_waylines, 0.0 );
  std::vector<real_type> KK_new( n_waylines, 0.0 );
  //
  fmt::print( "Compute new curvatures...\n" );
  S_new.get_SK(SS_new.data(), KK_new.data() );
  // sum all curvatures squared
  real_type curvature_cost = 0.0;
  for ( G2lib::integer i = 0; i < n_waylines; ++i ) {
    curvature_cost += KK_new[i] * KK_new[i];
  }
  fmt::print( "Curvature cost = {}\n", curvature_cost );
  return curvature_cost;
};


int
main() {

  G2lib::G2solve2arc      g2solve2arc;
  G2lib::G2solve3arc      g2solve3arc;
  G2lib::ClothoidSplineG2 g2spline;
  G2lib::ClothoidList S("Test G2 Bilevel");
  
  integer N{500};
  real_type X[]{
     0 , -1.81091370790631, -3.62486084815623, -5.43785083447276, -7.24624388514158, -9.05026411315365, -10.8505866906144, -12.6464975130675, -14.4391048496518, -16.2336412678707, -18.0361088459689, -19.1246432901682, -19.4893506278752, -19.8552323572701, -20.2224911165884, -20.5915980606546, -20.9631023077921, -21.3375512753946, -21.7154902504961, -22.0974608187427, -22.4839961215030, -22.8756242365056, -23.2728693261332, -23.6762511293050, -24.0862440905667, -24.5031220914651, -24.9270964645924, -25.3583755441135, -25.7971645067131, -26.2436689277993, -26.6981091698561, -27.1607071954080, -27.6316806249288, -28.1112424878625, -28.5996129071156, -29.0970662121989, -29.6038885117003, -30.1203584083631, -30.6467465169685, -31.1832747760361, -31.7299540203774, -32.2867276108942, -32.8535368634398, -33.4303210661288, -34.0170016845590, -34.6134177217948, -35.2193829499806, -35.8347124590537, -36.4592227370899, -37.0927532945450, -37.7352565925320, -38.3867190507561, -39.0471236875587, -39.7164500325489, -40.3946414705730, -41.0814671309900, -41.7766430250520, -42.4798902686286, -43.1909351356996, -43.9095200646837, -44.6354511019201, -45.3685567165674, -46.1086676309309, -46.8556168340782, -47.6093109411217, -48.3700432111594, -49.1382223870182, -49.9142359300502, -50.6984481231532, -51.4914387034004, -52.2950766748555, -53.1115374885917, -53.9427696361982, -54.7904434132293, -55.6561481211749, -56.5424483413013, -57.4514860988831, -58.3841159672203, -59.3396306526563, -60.3152248744518, -61.3052366269166, -62.3036281782854, -63.3048582427746, -64.3039002925240, -65.2962732892131, -66.2782087211193, -67.2466897452519, -68.1993950949137, -69.1346516610326, -70.0511982163082, -70.9471654114861, -71.8204336304649, -72.6689303795847, -73.4906356290031, -74.2839914983909, -75.0499186319541, -75.7906566348262, -76.5089572357723, -77.2079900945551, -77.8910782529671, -78.5607731454999, -79.2194147288353, -79.8694448960593, -80.5133824477224, -81.1536160566909, -81.7915009384603, -83.7009099844811, -84.3391363250764, -84.9790029444960, -85.6204162113931, -86.2632825570346, -86.9075088390544, -87.5529668352392, -90.1395265126758, -92.0768154441000, -92.7236902765892, -93.3721785330039, -94.0227794458883, -94.6751793447269, -97.9431715164195, -101.197120736236, -104.442735500145, -107.688791896129, -110.935047367714, -114.180838963828, -117.425780961986, -120.669924917019, -123.913496043007, -127.156628745022, -130.399614777594, -133.643025404063, -136.887240627490, -140.132278357303, -143.378136269197, -146.624751342092, -149.872072322153, -153.119894138684, -156.367234329063, -159.612545035054, -162.854894465279, -166.095416539388, -169.333497343486, -172.569972671446, -173.218227801578, -173.867319662644, -174.517497439508, -175.168997884775, -175.821950521371, -176.476426964874, -177.132497881677, -177.790233530068, -178.449619777500, -179.769712926023, -180.427955695814, -181.083342245506, -181.734125041974, -182.373566437083, -182.991770378686, -183.578188998052, -184.121439526796, -184.609555471066, -185.033840857577, -185.387812147135, -185.665023741545, -185.859185311677, -185.964822544726, -185.981528397723, -185.912062221712, -185.759828335415, -185.528724424102, -185.222824591279, -184.844767424314, -184.396678267420, -183.881098596160, -183.300982333811, -182.660319282894, -181.968530617643, -181.236716038069, -180.474731408201, -179.691327426379, -178.894137619212, -178.088191465993, -177.277247254320, -176.464930988199, -175.654833989560, -174.850311981140, -174.052212530991, -173.260019816734, -172.473182152986, -171.691126634008, -170.913300699823, -170.139492149305, -169.369673662302, -168.603818230171, -167.841897436893, -167.083884050738, -166.329773297440, -165.579572502688, -164.833288592985, -164.090927977222, -163.352489619055, -162.617906490244, -161.887073807553, -161.159884040756, -160.436227373033, -159.715975759125, -158.998845263196, -158.284462303148, -157.572447686803, -156.862418200716, -156.154002476261, -155.446974165637, -154.741188677304, -154.036501572572, -153.332767736691, -152.629855111408, -151.927766017707, -151.226579716490, -150.526376654007, -149.827237594704, -149.129248996955, -148.432551554810, -147.737317841362, -147.043721804811, -146.351938504556, -145.662151960720, -144.974626900117, -144.289676892351, -143.607619117868, -142.928774121905, -142.253472905810, -141.582121210851, -140.915172428896, -140.253087249701, -139.596333689996, -138.945355154811, -138.300257127245, -137.660937177413, -137.027287039905, -136.399195536458, -135.776537820923, -135.159068806691, -134.546467152393, -133.938405316297, -133.334550991648, -132.734589514118, -132.138444035599, -131.546186203071, -130.957890402655, -130.373631574025, -129.793482098405, -129.217480057022, -128.645641822568, -128.077983341589, -127.514520465867, -126.955262880023, -126.400150990600, -125.849080423238, -125.301944874359, -124.758636853255, -124.219047723353, -123.683067675537, -123.150585802364, -122.621490193896, -122.095667982690, -121.573005607659, -121.053391239136, -120.536713931135, -120.022862002121, -119.511723043155, -119.003185340591, -118.497153173145, -117.993541279935, -117.492264137447, -116.993235785933, -116.496369996184, -116.001581939368, -115.508787618810, -115.017902711812, -114.528842564956, -114.041521633151, -113.555846880329, -113.071720090413, -112.589042657053, -112.107715696462, -111.627640900067, -111.148730272342, -110.670902868432, -110.194077719642, -107.822249856081, -105.464426480789, -103.111460922173, -100.754849914908, -98.3897697242409, -96.0160099352633, -93.6359076026674, -91.2522845288712, -88.8686737297963, -86.4884903454885, -84.1120097003937, -81.7367675897361, -79.3617778216474, -76.9881636317516, -74.6165098648883, -72.2460382961565, -69.8751677312133, -67.5019681154449, -65.1230789744201, -62.7333223087011, -61.2913847019615, -60.8089912320832, -60.3255942952828, -59.8411154075482, -59.3554759456433, -58.8685915053712, -58.3803724403703, -57.8907291381994, -57.3995722385342, -56.9068133745030, -56.4123790306222, -55.9162094318653, -55.4182455289250, -54.9184284963025, -54.4167080393187, -53.9132047567947, -53.4081989641250, -52.9019763324037, -51.3792448579094, -50.8723896908500, -50.3674238173560, -49.8653047438225, -49.3669137044904, -48.3761293003434, -47.8785249975733, -47.3759376731445, -46.8657494183541, -46.3450257733992, -45.8105516866047, -45.2592009811102, -44.6879822759471, -44.0940455523043, -43.4741003793653, -42.8245266120280, -42.1421302448473, -41.4242778549747, -40.6690224355909, -39.8754508586328, -39.0437534561136, -38.1750651035830, -37.2715662548009, -36.3366517279621, -35.3760316027009, -34.3965742571670, -33.4045319335372, -32.4054537275568, -31.4041817826047, -30.4048387689484, -29.4107862549948, -28.4246463025177, -27.4483519180299, -26.4832023970398, -25.5299206559173, -24.5887120296296, -23.6593237223778, -22.7411028440231, -21.8330573808649, -20.9340109228695, -20.0426663884502, -19.1575586540597, -18.2770890546614, -17.3995839578159, -16.5238071275386, -14.7744183689712, -13.8993155132232, -13.0229703637672, -12.1451732810801, -11.2662309844480, -10.3864696213049, -5.98527673017217, -5.10580813030974, -4.22689710518433, 0.162039802775382, 4.55216469319298, 8.94972556598060, 13.3521718670766, 17.7550602800543, 22.1584764154606, 26.5632261022788, 30.9703792944571, 35.3799095971868, 39.7881817530428, 44.1910840872264, 48.5905167483607, 50.3523171363141, 51.2339364428973, 52.1160813984619, 53.8814238178763, 54.7627205210076, 55.6412679480317, 56.5156306200259, 57.3843013397190, 58.2454388462690, 59.0967494237346, 59.9357274761346, 60.7596394844981, 61.5655154882584, 62.3510239752458, 63.1148816322622, 63.8558637978836, 64.5727343590174, 65.2642566681860, 65.9294963398288, 66.5679507227468, 67.1792082668904, 67.7629216128349, 68.3187789122547, 68.8454638523902, 69.3402317293497, 69.8001464482787, 70.2221830966801, 70.6032653995537, 70.9411948994782, 71.2350447923960, 71.4840615282289, 71.6875838293565, 71.8450641713370, 71.9568139277994, 72.0242628549697, 72.0490175450617, 72.0327728813082, 71.9772990881283, 71.8846415490046, 71.7571746932366, 71.5973099252206, 71.4074614596222, 71.1900368576288, 70.9474982158991, 70.6823786054366, 70.3971867533238, 70.0943979544085, 69.7764456723866, 69.4453781342362, 69.1027362650171, 68.7500085544335, 68.3886675265380, 68.0201683138980, 67.6458145164036, 67.2667066882265, 66.8839243976331, 66.4985420389940, 65.7243597303319, 65.3380217140504, 64.9539272731020, 64.5733894033996, 64.1977160568532, 63.8276731736260, 63.4632420037966, 63.1043423375893, 62.7508931287943, 62.4027966790699, 62.0591547032951, 61.3768847932271, 61.0339365608754, 60.6869279977228, 60.3349995109763, 59.9791467029099, 59.6205082396518, 57.8177602373373, 56.0152227446096, 54.2110439072441, 52.4042428185612, 50.5937728895602, 48.7787835633878, 46.9580994286296, 45.1311010445311, 43.2985869293451, 41.4621972852598, 39.6235975541769, 37.7842479683586, 35.9455543548419, 34.1090733057852, 32.2763636542337, 30.4485078371036, 28.6257374288684, 26.8071028155913, 24.9903966750181, 23.1732451361001, 21.3555013853851, 19.5394348699823, 17.7262740734253, 15.9152726769517, 14.1056111826568, 12.2967519373045, 10.4881499291911, 8.67947798296385, 6.87072581422386, 5.06205401440782, 3.25371202926579, 1.44591580736192, -0.000163118306680421
  };
  real_type Y[]{
    0, -4.66828162115883, -9.33538551004196, -14.0028612103763, -18.6721197580859, -23.3430696388417, -28.0154459346829, -32.6895196982583, -37.3648616021781, -42.0394631786679, -46.7110112696832, -49.5112081174279, -50.4438811404693, -51.3760940652668, -52.3077653009772, -53.2387057692137, -54.1686920223256, -55.0974963578910, -56.0248858564912, -56.9506218925213, -57.8744610029870, -58.7961524502299, -59.7154366545929, -60.6320443017931, -61.5457136616388, -62.4562620304994, -63.3635276985814, -64.2673436465359, -65.1675374023190, -66.0639290366995, -66.9563234542058, -67.8445161992392, -68.7282960676247, -69.6074449595240, -70.4817310258377, -71.3508807920653, -72.2146003946645, -73.0725855363927, -73.9245212459321, -74.7701073423263, -75.6091664377848, -76.4415614615845, -77.2671555039112, -78.0858118296389, -78.8974053992259, -79.7018719500686, -80.4991704589530, -81.2892645114768, -82.0721222080698, -82.8476983536751, -83.6158576154701, -84.3764334606166, -85.1292577934622, -85.8741610170594, -86.6110022773731, -87.3398024516926, -88.0606423523002, -88.7736104392692, -89.4788025101496, -90.1763100268695, -90.8661689980771, -91.5483989150701, -92.2230229320457, -92.8900677902182, -93.5494817355533, -94.2007624683569, -94.8432416092645, -95.4762345690147, -96.0990400408927, -96.7106250506726, -97.3081399558988, -97.8879973452015, -98.4464576035053, -98.9796113262363, -99.4829244647918, -99.9489480335908, -100.368805542475, -100.733143742983, -101.032192577043, -101.257130545934, -101.406423175877, -101.481632353121, -101.484796647137, -101.418349856714, -101.285199068708, -101.089302851031, -100.835031291142, -100.526815863667, -100.169084380459, -99.7658012343034, -99.3186575590141, -98.8286606943968, -98.2969209042536, -97.7246499470230, -97.1136695706261, -96.4686068183537, -95.7947429228216, -95.0969896901946, -94.3799169216701, -93.6476272586129, -92.9030625159028, -92.1486968701147, -91.3868940860202, -90.6199314750442, -89.8498728373521, -89.0778670615394, -86.7583477090362, -85.9866241384802, -85.2162600178128, -84.4471831491562, -83.6793204609465, -82.9125983607302, -82.1469128315463, -79.0881621636018, -76.7918769811870, -76.0273881086556, -75.2642675593113, -74.5029474274481, -73.7431681324445, -69.9494256603823, -66.1436343855536, -62.3307290291334, -58.5181995559276, -54.7058395813214, -50.8930846711931, -47.0796066678057, -43.2654497357960, -39.4508056524827, -35.6357888208116, -31.8206473087631, -28.0058667640262, -24.1917704553475, -20.3783739109270, -16.5656754590058, -12.7536217251267, -8.94216930628116, -5.13114364231062, -1.31970760677669, 2.49345648960618, 6.30913890519897, 10.1263734642147, 13.9456788383407, 17.7663447663252, 18.5296636643688, 19.2922711319428, 20.0539529382261, 20.8145036655987, 21.5738079918988, 22.3317992569859, 23.0884108423303, 23.8435756721001, 24.5972997615184, 26.1035917678211, 26.8583143970950, 27.6155179547842, 28.3766785239384, 29.1473718427879, 29.9351666022109, 30.7468482411839, 31.5879688681276, 32.4621744193657, 33.3690456409349, 34.3055709329823, 35.2675830626203, 36.2496979817755, 37.2452133761965, 38.2461980791549, 39.2449302692352, 40.2344539070956, 41.2086009133763, 42.1619233866152, 43.0889999605890, 43.9843282711756, 44.8425664416545, 45.6585681284930, 46.4279738821751, 47.1518462208489, 47.8353082470023, 48.4850312917407, 49.1088132964888, 49.7149093765997, 50.3093252284369, 50.8969114165757, 51.4826013645326, 52.0713537953417, 52.6676966354548, 53.2726090941452, 53.8852379845454, 54.5047308521414, 55.1302509436617, 55.7610234071131, 56.3967179404153, 57.0372386677107, 57.6824927674986, 58.3323882905414, 58.9868371160297, 59.6457791175576, 60.3091691881426, 60.9769625489653, 61.6491146084788, 62.3255734284185, 63.0062169061496, 63.6908859354206, 64.3794230075530, 65.0716725614539, 65.7674643848480, 66.4664728997515, 67.1682894012075, 67.8725087657304, 68.5787297770228, 69.2865696802025, 69.9957954604610, 70.7062580873145, 71.4178102198528, 72.1303051933319, 72.8436103628686, 73.5577261162500, 74.2727283206575, 74.9886934225725, 75.7056975398023, 76.4238216289298, 77.1431983692277, 77.8639897562363, 78.5863571060893, 79.3104605630039, 80.0364663096248, 80.7646138882987, 81.4951841064993, 82.2284550462472, 82.9647010938403, 83.7041986721048, 84.4472833174152, 85.1943218944299, 85.9456739404068, 86.7016903124876, 87.4626846864756, 88.2286704683168, 88.9994855686852, 89.7749684174348, 90.5549603604891, 91.3392970373156, 92.1277253104377, 92.9199416901616, 93.7156481711688, 94.5145526359485, 95.3163848361635, 96.1210581744463, 96.9285971595246, 97.7390270100361, 98.5523719862894, 99.3686531672405, 100.187866219066, 101.009991153801, 101.835007652066, 102.662895301363, 103.493629525472, 104.327139753686, 105.163327445000, 106.002095248444, 106.843347433816, 107.686989846797, 108.532929821048, 109.381076155509, 110.231339104168, 111.083630332811, 111.937863009142, 112.793953199134, 113.651819239520, 114.511380670853, 115.372558176373, 116.235274353292, 117.099462581275, 117.965063503847, 118.832018617477, 119.700270131569, 120.569761026822, 121.440435965367, 122.312240912292, 123.185122434816, 124.059027665266, 124.933903955133, 125.809695187788, 126.686343083867, 127.563789839663, 128.441978145370, 129.320851605713, 130.200359991644, 131.080457362072, 131.961098154049, 136.370934804764, 140.788278148158, 145.208212096073, 149.626202887152, 154.039665207450, 158.448465633934, 162.853845686935, 167.257322016590, 171.660804990548, 176.066141329434, 180.473476366096, 184.881479097231, 189.289617788529, 193.698497288022, 198.108431668848, 202.519001663714, 206.929357176065, 211.338459725136, 215.744494527614, 220.144642796660, 222.780325796935, 223.657928762990, 224.534979394393, 225.411432814304, 226.287243685751, 227.162363041596, 228.036738511993, 228.910317201641, 229.783045773523, 230.654870831533, 231.525746761671, 232.395635209675, 233.264497747618, 234.132295573911, 234.998994316750, 235.864658610242, 236.729447295047, 237.593524284967, 240.183370323831, 241.047076374129, 241.911888125582, 242.778355510306, 243.646972389633, 245.387635310922, 246.256703190408, 247.122897214636, 247.984633484208, 248.840040125945, 249.686917063923, 250.522896975238, 251.345419663807, 252.151679111345, 252.938097204743, 253.700201683401, 254.433033906824, 255.131137798828, 255.788556370315, 256.399133345309, 256.956615948039, 257.454442632822, 257.885812823642, 258.243968455359, 258.526073702009, 258.733639250844, 258.868975160186, 258.934914736282, 258.934718906195, 258.872255873609, 258.751889460365, 258.578125366483, 258.355527431362, 258.088659150652, 257.782040432259, 257.440114443287, 257.067223737310, 256.667598078469, 256.245341407861, 255.804233970658, 255.347752008177, 254.879282740329, 254.402147041451, 253.919577272301, 253.433876921638, 252.458581795235, 251.971667805079, 251.486993789607, 251.004954174043, 250.525005618683, 250.046559893045, 247.658723969120, 247.179740234484, 246.699734184792, 244.289447111182, 241.881324771373, 239.486809619302, 237.101284958945, 234.716576007965, 232.332841710924, 229.951572699297, 227.574755350104, 225.202350404165, 222.827609389345, 220.442929506106, 218.051852192752, 217.099161123795, 216.624147619541, 216.150111023439, 215.203999128030, 214.728388901027, 214.247722060003, 213.759488565712, 213.261204071688, 212.750020304710, 212.222645495022, 211.675878420029, 211.106677924682, 210.512233025448, 209.891128343479, 209.243584329479, 208.569986288923, 207.870784910953, 207.146505697767, 206.398012886442, 205.626544065169, 204.833351056316, 204.019672729823, 203.186715506992, 202.335019272199, 201.464403096370, 200.574892316880, 199.666807429071, 198.740798881752, 197.798188256414, 196.840920055089, 195.871023224278, 194.890570830849, 193.901678363125, 192.906574809218, 191.907483902759, 190.906418668309, 189.905173241136, 188.905327947639, 187.908234121171, 186.914983367026, 185.926423512029, 184.943175582191, 183.965649999568, 182.994045558294, 182.028353383690, 181.068392979617, 180.113832932194, 179.164212650170, 178.219082712292, 177.278085364081, 176.340820527112, 175.406841280291, 174.475662007140, 173.546820232403, 172.619908126093, 171.694506979110, 170.770185311235, 168.922970243769, 167.999047512131, 167.074190137641, 166.147864210404, 165.219555432703, 164.288988020476, 163.356208589317, 162.421286842177, 161.484290898882, 160.545293119562, 159.604655264399, 157.721554277699, 156.780663117705, 155.841262640037, 154.903694005874, 153.967607348204, 153.032584082609, 148.361143203397, 143.689620795135, 139.018732066195, 134.348857123341, 129.680403394790, 125.013704940501, 120.349225469022, 115.687215556428, 111.027370815672, 106.369051873519, 101.711604719678, 97.0544536307445, 92.3970435382254, 87.7387606313665, 83.0789927606341, 78.4173188395801, 73.7536540831365, 69.0883748515156, 64.4223442130140, 59.7564870203138, 55.0908605024812, 50.4245809520132, 45.7571715656114, 41.0889238372898, 36.4201565126774, 31.7510782983641, 27.0819004324630, 22.4127496577552, 17.7436299591977, 13.0744791280005, 8.40520055326609, 3.73571064876812, 5.75374942922424e-05
  };

  std::vector<curveLocProp> Curves{
    { 1,  59.49, 145.5, { 85.12, 120.18 } },
    { 2, 300.44, 328.21, { 310.45 } },
    { 3, 373.66, 408.47, { 380.55 } },
    { 4, 564.24, 601.67, { 580.84 } },
    { 5, 683.38, 734.03, { 711.02 } }
  };

  

  Utils::TicToc tictoc;


  tictoc.tic();
  S.build_G2_cyclic( N, X, Y );
  tictoc.toc();
  fmt::print( "build_G2_cyclic elapsed = {} [ms]\n", tictoc.elapsed_ms() );


  fmt::print( "building wayline structures...\n" );

  // create a vector of wayline using curve locations and peaks positions. if distance between end of one curve and start of next curve is more than curve_separation_tol, then add one or more wayline in the middle depending on the distance
  const real_type curve_separation_tol = 100.0;
  std::vector<wayLine> Waylines;
  // fist wayline from start from 0.0
  create_waylines(Curves,Waylines,curve_separation_tol);
  fmt::print( "number of waylines created = {}\n", Waylines.size() );
  // get wayline numbers to define optimization problem
  G2lib::integer n_waylines = static_cast<G2lib::integer>( Waylines.size() );

  // vector of ones of size n_waylines
  std::vector<real_type> offsets( n_waylines, 1.0 );

  fmt::print( "computing initial curvature cost...\n" );

  G2lib::real_type curvature_cost = compute_curvature_cost( S, Waylines, offsets );
  
  fmt::print( "curvature cost after rebuild = {}\n", curvature_cost );


  fmt::print( "\n\nALL DONE FOLKS!!!\n" );

  return 0;
}

